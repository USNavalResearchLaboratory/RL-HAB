

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>forecast_processing.forecast &mdash; RLHAB 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            RLHAB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About RL HAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../forecasts.html">Preparing Forecast Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../env.html">Environment Module (<cite>env</cite> Directory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citing.html">Citing RLHAB</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RLHAB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">forecast_processing.forecast</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for forecast_processing.forecast</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Current Assumptions for Synth and ERA5 forecast</span>

<span class="sd">- Both forecasts are downloaded for the same regions (0.25 degree resolution), same altitude band (config)</span>
<span class="sd">- Synth Forecast is 1 month @ 12 hour intervals</span>
<span class="sd">- Synth Forecast is 6 months @ 3 hour intervals</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">env.config.env_config</span> <span class="kn">import</span> <span class="n">env_params</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">utils.common</span> <span class="kn">import</span> <span class="n">convert_range</span><span class="p">,</span> <span class="n">quarter</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">CoordinateTransformations</span> <span class="k">as</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">line_profiler</span> <span class="kn">import</span> <span class="n">profile</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<div class="viewcode-block" id="Forecast">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast">[docs]</a>
<span class="k">class</span> <span class="nc">Forecast</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a full ERA5 or synthetic forecast into memory.</span>

<span class="sd">        This class handles large-scale climate forecasts used for simulations, supporting operations</span>
<span class="sd">        like subsetting, time adjustments, and aligning forecasts for simulating.</span>

<span class="sd">        Download from https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=form</span>

<span class="sd">        Attributes:</span>
<span class="sd">            forecast_type (str): Type of forecast (&#39;SYNTH&#39; or &#39;ERA5&#39;).</span>
<span class="sd">            ds_original (xarray.Dataset): Original dataset loaded from the forecast file.</span>
<span class="sd">            LAT_MIN, LAT_MAX (float): Latitude range of the forecast.</span>
<span class="sd">            LON_MIN, LON_MAX (float): Longitude range of the forecast.</span>
<span class="sd">            LEVEL_MIN, LEVEL_MAX (float): Pressure level range of the forecast.</span>
<span class="sd">            TIME_MIN, TIME_MAX (numpy.datetime64): Time range of the forecast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">forecast_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timewarp</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Forecast object and load a dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the forecast file.</span>
<span class="sd">            forecast_type (str): Type of forecast (&#39;SYNTH&#39; or &#39;ERA5&#39;).</span>
<span class="sd">            month (int, optional): Month to filter for ERA5 forecasts.</span>
<span class="sd">            timewarp (int, optional): Simulation Time interval adjustment (e.g., 3, 6, or 12 hours).</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the forecast type is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_type</span> <span class="o">=</span> <span class="n">forecast_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_forecast</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">timewarp</span><span class="o">=</span><span class="n">timewarp</span><span class="p">)</span>

        <span class="c1">#check and see if the forecast type is correct</span>
        <span class="k">if</span> <span class="n">forecast_type</span> <span class="o">!=</span> <span class="s2">&quot;SYNTH&quot;</span> <span class="ow">and</span> <span class="n">forecast_type</span> <span class="o">!=</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid forecast type &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">forecast_type</span><span class="p">))</span>
        
<div class="viewcode-block" id="Forecast.check_nan">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast.check_nan">[docs]</a>
    <span class="k">def</span> <span class="nf">check_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="n">nans_exist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">has_nan</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">has_nan</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: contains NaN? </span><span class="si">{</span><span class="n">has_nan</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
                <span class="n">nans_exist</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">nans_exist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">total_vals</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                <span class="n">n_nans</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">pct_nans</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_nans</span> <span class="o">/</span> <span class="n">total_vals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_nans</span><span class="si">}</span><span class="s2"> NaNs out of </span><span class="si">{</span><span class="n">total_vals</span><span class="si">}</span><span class="s2"> values (</span><span class="si">{</span><span class="n">pct_nans</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linear Filling Nans on time dimension&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">use_coordinate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">use_coordinate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">use_coordinate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linear Interpolation done&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ds</span></div>




<div class="viewcode-block" id="Forecast.load_forecast">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast.load_forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">load_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timewarp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and preprocess the forecast dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Path to the forecast file.</span>
<span class="sd">            month (int, optional): Month to filter for ERA5 forecasts.</span>
<span class="sd">            timewarp (int, optional): Time interval adjustment (e.g., 3, 6, or 12 hours).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">env_params</span><span class="p">[</span><span class="s2">&quot;forecast_directory&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1">#Check if the forecast is corrupt, handle it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_nan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="p">)</span>

        <span class="c1"># Drop temperature variable from forecasts if it exists</span>
        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>

        <span class="c1"># Do some reformatting for the new format of ERA5</span>
        <span class="k">if</span> <span class="s1">&#39;valid_time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="c1">#self.ds_original = self.ds_original.drop_vars(&#39;expver&#39;)</span>
            <span class="c1">#self.ds_original = self.ds_original.drop_vars(&#39;number&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;valid_time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pressure_level&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">})</span>

            <span class="c1">#self.ds_original[&#39;latitude&#39;] = self.ds_original[&#39;latitude&#39;].astype(&#39;float32&#39;)</span>
            <span class="c1">#self.ds_original[&#39;longitude&#39;] = self.ds_original[&#39;longitude&#39;].astype(&#39;float32&#39;)</span>

            <span class="c1">#reformat the pressure level to match the old format</span>
            <span class="c1">#self.ds_original[&#39;level&#39;] = self.ds_original[&#39;level&#39;].astype(&#39;int32&#39;)</span>
            <span class="c1">#Reverse the &#39;level&#39; coordinate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">level</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DID WE GO IN HERE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_type</span> <span class="o">==</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">:</span>
            <span class="n">memory_size_gb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span>
            <span class="c1"># Print the memory size of the dataset in gigabytes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory size of the dataset: </span><span class="si">{</span><span class="n">memory_size_gb</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>

        <span class="c1"># Reverse order of latitude, since era5 comes reversed for some reason (We set up synth to be the same)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">latitude</span><span class="p">)))</span>


        <span class="c1"># Cut off any pressure levels that are not in range of the altitude (only checking top bounds right now)</span>
        <span class="n">da_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">da_slice</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">9.81</span> <span class="o">-</span> <span class="n">env_params</span><span class="p">[</span><span class="s2">&quot;alt_max&quot;</span><span class="p">]))</span>
        <span class="n">max_pres_level</span> <span class="o">=</span> <span class="n">da_slice</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">max_pres_level</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1">#print(&#39;Max_pres level&#39;, max_pres_level)</span>


        <span class="c1"># Some forecast formatting helper functions that are performed by default with v1.0</span>
        <span class="c1"># Only include same ERA5 month as Synth, unless month is not specified</span>
        <span class="c1"># Need to format ERA5 before timewarping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_type</span> <span class="o">==</span> <span class="s2">&quot;ERA5&quot;</span> <span class="ow">and</span> <span class="n">month</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_era5_months</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>


        <span class="c1"># Change the simulation timestamps of forecasts</span>
        <span class="k">if</span> <span class="n">timewarp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TIMEWARP</span><span class="p">(</span><span class="n">timewarp</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast_type</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="p">)</span>

        <span class="c1"># Set master forecast variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LAT_MIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LAT_MAX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LAT_DIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LON_MIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LON_MAX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LON_DIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LEVEL_MIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LEVEL_MAX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LEVEL_DIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">TIME_MIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TIME_MAX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TIME_DIM</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>


        <span class="c1">#print(f&quot;LAT RANGE: ({self.LAT_DIM }) {self.LAT_MIN}, {self.LAT_MAX}&quot;)</span>
        <span class="c1">#print(f&quot;LON RANGE: ({self.LON_DIM}) {self.LON_MIN}, {self.LON_MAX}&quot;)</span>
        <span class="c1">#print(f&quot;PRES RANGE: ({self.LEVEL_DIM}) {self.LEVEL_MIN}, {self.LEVEL_MAX}&quot;)</span>
        <span class="c1">#print(f&quot;TIME RANGE: ({self.TIME_DIM}) {self.TIME_MIN}, {self.TIME_MAX}&quot;)</span>


<div class="viewcode-block" id="Forecast.drop_era5_months">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast.drop_era5_months">[docs]</a>
    <span class="k">def</span> <span class="nf">drop_era5_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter ERA5 forecast to match the specified month and reduce time intervals to 12 hours. This is a bit hardcoded rn</span>

<span class="sd">        By default, ERA5 forecasts are downloaded in 6 month @ 3 hour intervals. Since many simulations require</span>
<span class="sd">        both Synth and ERA5, we need change ERA5 to 12 hour intervals</span>

<span class="sd">        Args:</span>
<span class="sd">            month (int): Month to retain in the dataset.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the specified month is not within the forecast&#39;s range.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s2">&quot;DROPPING ERA5 Months except (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) and  Times: (12) hour intervals&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">))</span>

        <span class="c1"># for error printing</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Reformat the ERA5 forecast to only have times every 12 hours like Synth Forecasts</span>
        <span class="c1"># Also Only include the same month if ERA5 has more than a month</span>
        <span class="n">month_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
        <span class="n">hour_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">month_mask</span> <span class="o">&amp;</span> <span class="n">hour_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">combined_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Month </span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2"> is out of range of ERA forecast with time range of </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Forecast.TIMEWARP">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast.TIMEWARP">[docs]</a>
    <span class="k">def</span> <span class="nf">TIMEWARP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timewarp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        By Default ERA5 forecasts are downloaded in 3 hour intervals, whereas Synth are in 12 hour intervals</span>

<span class="sd">        Therefore we perform a &quot;timewarp&quot; to overwrite timestamps in both forecasts, while still matching</span>
<span class="sd">        up the data from the original timestamps with the new timestamps.</span>

<span class="sd">        For example:</span>

<span class="sd">        Synth (original):   2024-01-01 00:00:00, 2024-01-01 12:00:00, 2024-01-02 00:00:00, 2024-01-02 12:00:00</span>
<span class="sd">        *original timestamps will be overwritten with the timewarp function</span>
<span class="sd">        Synth (timewarp) :  2024-01-01 00:00:00, 2024-01-01 03:00:00, 2024-01-01 06:00:00, 2024-01-01 09:00:00</span>
<span class="sd">        *to line up with the ERA5</span>
<span class="sd">        ERA5:               2024-01-01 00:00:00, 2024-01-01 03:00:00, 2024-01-01 06:00:00, 2024-01-01 09:00:00</span>

<span class="sd">        Timewarping will typically only be used for Synth Forecast due to their sparse timing</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">timewarp</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timewarp</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">timewarp</span> <span class="o">!=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">timewarp</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s2">&quot;Timewarp only accepts hour intervals of 1,3,6,12&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s2">&quot;TIMEWARPING (&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_type</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">))</span>

        <span class="c1"># determine initial time variables (temporary, not assigned)</span>
        <span class="n">time_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Add timewarp time interval to the forecast</span>
        <span class="n">synth_simulated_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_dim</span><span class="p">):</span>
            <span class="n">synth_simulated_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_min</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">timewarp</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synth_simulated_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">synth_simulated_time</span><span class="p">)</span></div>
</div>


        <span class="c1">#print(self.ds_original.time)</span>
        <span class="c1">#sdfsdf</span>


<div class="viewcode-block" id="Forecast_Subset">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset">[docs]</a>
<span class="k">class</span> <span class="nc">Forecast_Subset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a subset of the master forecast for efficient processing and simulation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Forecast (Forecast): Master forecast object.</span>
<span class="sd">        lat_central (float): Central latitude of the subset.</span>
<span class="sd">        lon_central (float): Central longitude of the subset.</span>
<span class="sd">        start_time (numpy.datetime64): Start time of the subset.</span>
<span class="sd">        ds (xarray.Dataset): Subset dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load from config file for now.  Maybe change this later</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Forecast</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Forecast_Subset object.</span>

<span class="sd">        Args:</span>
<span class="sd">            Forecast (Forecast): Master forecast object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span> <span class="o">=</span> <span class="n">Forecast</span>

<div class="viewcode-block" id="Forecast_Subset.assign_coord">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.assign_coord">[docs]</a>
    <span class="k">def</span> <span class="nf">assign_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign central coordinates and timestamp for the subset.</span>

<span class="sd">        Args:</span>
<span class="sd">            lat (float): Central latitude.</span>
<span class="sd">            lon (float): Central longitude.</span>
<span class="sd">            timestamp (numpy.datetime64): Start timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Round time to nearest hour and quarter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[h]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forecast_Subset.randomize_coord">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.randomize_coord">[docs]</a>
    <span class="k">def</span> <span class="nf">randomize_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np_rng</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a random coordinate to centralize the Forecast Subset, and stores the coordinate for look up by other classes.</span>

<span class="sd">        Altitude Bounds are the same as the PRIMARY FORECAST</span>
<span class="sd">        Horizontal Bounds are within 2 degrees of the min/max LAT/LON from the PRIMARY FORECAST</span>
<span class="sd">        Time Bounds are between the start time and up to 24 hours before the final timestamp of the PRIMARY FORECAST</span>

<span class="sd">        pass np_rng to have forecasts randomize in the same order when manually setting seed</span>

<span class="sd">        Args:</span>
<span class="sd">            np_rng (numpy.random.Generator): Random number generator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#print(&quot;RANDOM NUMBER&quot;, np_rng.uniform(low=0, high=100))</span>
        <span class="c1">#print(&quot;RANDOM NUMBER 2&quot;, np.random.uniform(low=0, high=100))</span>

        <span class="n">lat</span> <span class="o">=</span> <span class="n">np_rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">LAT_MIN</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">LAT_MAX</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np_rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">LON_MIN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">LON_MAX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#Convert time to unix for randomizing.</span>
        <span class="c1"># Subtract 24 hours from the end for simulating.</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np_rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unixtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">TIME_MIN</span><span class="p">),</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unixtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">TIME_MAX</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">)))</span>
        <span class="c1"># Convert time back to dt64</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">),</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="c1">#Round time to nearest hour and quarter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[h]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fourecast_error_count</span> <span class="o">=</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="Forecast_Subset.get_alt_from_pressure">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.get_alt_from_pressure">[docs]</a>
    <span class="k">def</span> <span class="nf">get_alt_from_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pressure</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get average altitude from ERA5 for a forecast subset. Average is taken since z is geopotential converted</span>
<span class="sd">        to altitude</span>

<span class="sd">        Args:</span>
<span class="sd">            pressure (float): atmospheric pressure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            alt: corresponding altitude (from geopotential) for pressure level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use sel() to find the matching index</span>
            <span class="n">alt_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">pressure</span><span class="p">})</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mf">9.81</span>
            <span class="n">avg_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alt_array</span><span class="p">)</span>


            <span class="k">return</span> <span class="n">avg_alt</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s2"> doesn&#39;t exist in the levels.&quot;</span><span class="p">,</span><span class="s2">&quot;yellow&quot;</span><span class="p">))</span>
            <span class="c1"># Return a message if the value is not found</span>
            <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="Forecast_Subset.subset_forecast">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.subset_forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">subset_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subsets the Forecast to the central coordinate. This assume a random coordinate or user input coordinate has already been assigned.</span>

<span class="sd">        Horizontal Bounds are determined by the relative distance (converted to lat/lon degrees)</span>
<span class="sd">        Altitude is the same</span>
<span class="sd">        Time is 24 hours</span>

<span class="sd">        Converts the DataSet to a numpy array for faster processing</span>

<span class="sd">        Args:</span>
<span class="sd">            days (int): Number of days to include in the subset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rel_dist</span> <span class="o">=</span> <span class="n">env_params</span><span class="p">[</span><span class="s1">&#39;rel_dist&#39;</span><span class="p">]</span>
        <span class="n">pres_min</span> <span class="o">=</span> <span class="n">env_params</span><span class="p">[</span><span class="s1">&#39;pres_min&#39;</span><span class="p">]</span>
        <span class="n">pres_max</span> <span class="o">=</span> <span class="n">env_params</span><span class="p">[</span><span class="s1">&#39;pres_max&#39;</span><span class="p">]</span>

        <span class="c1">#1.  Calculate Lat/Lon Coordinates for subsetting the data to The relative distance area</span>
        <span class="n">lat_min</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">meters_to_latlon_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">rel_dist</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">meters_to_latlon_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span> <span class="o">-</span><span class="n">rel_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">lat_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">meters_to_latlon_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rel_dist</span><span class="p">)</span>
        <span class="n">_</span> <span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">meters_to_latlon_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span> <span class="n">rel_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#Round to nearest .25 degree resolution since that&#39;s the res of ERA5 forecasts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_min</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lat_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_min</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lon_min</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lat_max</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lat_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_max</span> <span class="o">=</span> <span class="n">quarter</span><span class="p">(</span><span class="n">lon_max</span><span class="p">)</span>

        <span class="c1">#print(&quot;SUBSETTING&quot;)</span>


        <span class="c1">#2. Subset the forecast to a smaller array</span>
        <span class="c1"># This may not be necessary for simulating, but good for forecast visualization)</span>
        <span class="c1"># No time for now?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Forecast</span><span class="o">.</span><span class="n">ds_original</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_max</span><span class="p">),</span>
                              <span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_max</span><span class="p">),</span>
                              <span class="n">level</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">pres_min</span><span class="p">,</span><span class="n">pres_max</span><span class="p">),</span>
                              <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)))</span> <span class="c1">#1 day of time for now</span>

        <span class="c1"># 3. Determine new min and max values from the subsetted forecast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lon_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#Now Calculate new Dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">latitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">longitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

        <span class="c1"># Convert the subset forecast Dataset to a numpy array for faster processing</span>

        <span class="c1"># Make sure the forecast subset has been changed to the right order:</span>
        <span class="n">ordered_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="c1"># Reorder ds2 to match ds1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">ordered_vars</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span></div>




<div class="viewcode-block" id="Forecast_Subset.xr_lookup">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.xr_lookup">[docs]</a>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">xr_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>

        <span class="c1"># How to look up indicies for xarray</span>
        <span class="c1">#time_idx = list(self.ds.time.values).index(self.ds.sel(time=timestamp, method=&#39;nearest&#39;).time)</span>
        <span class="c1">#lat_idx = list(self.ds.latitude.values).index(self.ds.sel(latitude=lat, method=&#39;nearest&#39;).latitude)</span>
        <span class="c1">#lon_idx = list(self.ds.longitude.values).index(self.ds.sel(longitude=lon, method=&#39;nearest&#39;).longitude)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">GRAVITY</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forecast_Subset.get_unixtime">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.get_unixtime">[docs]</a>
    <span class="k">def</span> <span class="nf">get_unixtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt64</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert numpy.datetime64 to Unix time in seconds.</span>

<span class="sd">        Args:</span>
<span class="sd">            dt64 (numpy.datetime64): DateTime value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Unix timestamp in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dt64</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Forecast_Subset.np_lookup">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.np_lookup">[docs]</a>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">np_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a fast lookup for wind data using numpy arrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            lat (float): Latitude.</span>
<span class="sd">            lon (float): Longitude.</span>
<span class="sd">            time (numpy.datetime64): Time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Altitude, u-component, and v-component of the wind.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(lat, self.lat_min, self.lat_max, 0, self.lat_dim)</span>
        <span class="n">lat_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">convert_range</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_dim</span><span class="p">))</span>
        <span class="n">lon_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">convert_range</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_dim</span><span class="p">))</span>
        <span class="n">time_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">convert_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unixtime</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">time</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unixtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">get_unixtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">))</span>

        <span class="c1"># Cast again see if that fixes the problem</span>
        <span class="c1"># Clip idx&#39;s to out of bounds.  Should I add a warning here?</span>
        <span class="n">lat_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lat_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">lon_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lon_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">time_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">time_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>


        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">lat_idx</span><span class="p">,</span> <span class="n">lon_idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">GRAVITY</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">lat_idx</span><span class="p">,</span> <span class="n">lon_idx</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast_np</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">time_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">lat_idx</span><span class="p">,</span> <span class="n">lon_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="Forecast_Subset.windVectorToBearing">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.windVectorToBearing">[docs]</a>
    <span class="k">def</span> <span class="nf">windVectorToBearing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to convert u-v wind components to bearing and speed.</span>

<span class="sd">        Not being used right now.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bearing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="mf">.5</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bearing</span><span class="p">,</span> <span class="n">speed</span></div>


<div class="viewcode-block" id="Forecast_Subset.interpolate_wind">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.interpolate_wind">[docs]</a>
    <span class="k">def</span> <span class="nf">interpolate_wind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Interpolates the u and v wind components given a 3D coordinate (lat,lon,alt)</span>
<span class="sd">        Currently only interpolating in the Z direction.  No smoothing for time or horizontal changes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#need to change to ascending order for interpolating with numpy</span>
        <span class="n">u_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">z</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">v_wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="n">z</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">u_wind</span><span class="p">,</span> <span class="n">v_wind</span></div>


<div class="viewcode-block" id="Forecast_Subset.getNewCoord">
<a class="viewcode-back" href="../../API/forecast_processing.html#forecast_processing.forecast.Forecast_Subset.getNewCoord">[docs]</a>
    <span class="k">def</span> <span class="nf">getNewCoord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Balloon</span><span class="p">,</span> <span class="n">SimulationState</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines new coordinate based on the flow at the current position and integrates forward int time via dt</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#get Wind at current lat/lon</span>
        <span class="n">z_col</span><span class="p">,</span> <span class="n">u_col</span><span class="p">,</span> <span class="n">v_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_lookup</span><span class="p">(</span><span class="n">Balloon</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">Balloon</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">SimulationState</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">x_vel</span><span class="p">,</span> <span class="n">y_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_wind</span><span class="p">(</span><span class="n">Balloon</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span> <span class="n">z_col</span><span class="p">,</span> <span class="n">u_col</span><span class="p">,</span> <span class="n">v_col</span> <span class="p">)</span>

        

        <span class="c1">#print(&quot;alt&quot;, Balloon.altitude, z_col, &quot;u_vel:&quot;, u_col, &quot;v_vel&quot;, v_col)</span>


        <span class="c1">#Get current relative X,Y Position</span>
        <span class="n">relative_x</span><span class="p">,</span> <span class="n">relative_y</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">latlon_to_meters_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span>
                                                                <span class="n">Balloon</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">Balloon</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
        

        <span class="c1"># If relative distance is nan from the transform step being too close to the central coordinate, revert back to 0. </span>


        <span class="c1">#print()</span>
        <span class="c1">#print(&quot;alt&quot;, Balloon.altitude, &quot;x_vel:&quot;, x_vel, &quot;y_vel&quot;, y_vel)</span>
        <span class="c1">#print(&quot;relative_x&quot;, relative_x, &quot;relative_y&quot; , relative_y )</span>

        <span class="c1">#Apply the velocity to relative Position</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="n">relative_x</span> <span class="o">+</span> <span class="n">x_vel</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">y_new</span> <span class="o">=</span>  <span class="n">relative_y</span> <span class="o">+</span> <span class="n">y_vel</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="c1"># Convert New Relative Position back to Lat/Lon</span>
        <span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">meters_to_latlon_spherical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span>
                                                                <span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
        
        <span class="c1"># Similarly, If lat or lon is nan from the transform step being too close to the central coordinate, revert back to central coordinate. </span>
        <span class="c1">#print(&quot;relative distance&quot;, relative_x, relative_y, x_vel, y_vel, dt)</span>
        <span class="c1">#if lat_new == np.nan:</span>
        <span class="c1">#    lat_new = self.lat_central</span>
        <span class="c1">#if lon_new == np.nan:</span>
        <span class="c1">#    lon_new = self.lon_central</span>

        <span class="c1">#print(&quot;x_new&quot;, x_new, &quot;y_new&quot;, y_new)</span>
        <span class="c1">#print(&quot;pre_lat&quot;, Balloon.lat, &quot;pre_lon&quot;, Balloon.lon)</span>
        <span class="c1">#print(&quot;lat_new&quot;, lat_new, &quot;lon_new&quot;, lon_new)</span>


        <span class="k">return</span> <span class="p">[</span><span class="n">lat_new</span><span class="p">,</span> <span class="n">lon_new</span><span class="p">,</span> <span class="n">x_vel</span><span class="p">,</span> <span class="n">y_vel</span><span class="p">,</span> <span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span> <span class="p">]</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#Can&#39;t use utils.initialize_forecast here, because it would be a circular import</span>
    <span class="n">FORECAST_SYNTH</span> <span class="o">=</span> <span class="n">Forecast</span><span class="p">(</span><span class="n">env_params</span><span class="p">[</span><span class="s1">&#39;synth_netcdf&#39;</span><span class="p">],</span> <span class="n">forecast_type</span><span class="o">=</span><span class="s2">&quot;SYNTH&quot;</span><span class="p">,</span> <span class="n">timewarp</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Get month associated with Synth</span>
    <span class="n">synth_month</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">FORECAST_SYNTH</span><span class="o">.</span><span class="n">TIME_MIN</span><span class="p">)</span><span class="o">.</span><span class="n">month</span>
    <span class="c1"># Then process ERA5 to span the same timespan as a monthly Synthwinds File</span>
    <span class="n">FORECAST_ERA5</span> <span class="o">=</span> <span class="n">Forecast</span><span class="p">(</span><span class="n">env_params</span><span class="p">[</span><span class="s1">&#39;era_netcdf&#39;</span><span class="p">],</span> <span class="n">forecast_type</span><span class="o">=</span><span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">synth_month</span><span class="p">,</span> <span class="n">timewarp</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


    <span class="n">forecast_subset</span> <span class="o">=</span> <span class="n">Forecast_Subset</span><span class="p">(</span><span class="n">FORECAST_ERA5</span><span class="p">)</span> <span class="c1">#Choose FORECAST_SYNTH or FORECAST_ERA5 here</span>
    <span class="n">forecast_subset</span><span class="o">.</span><span class="n">randomize_coord</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;random_coord&quot;</span><span class="p">,</span> <span class="n">forecast_subset</span><span class="o">.</span><span class="n">lat_central</span><span class="p">,</span> <span class="n">forecast_subset</span><span class="o">.</span><span class="n">lon_central</span><span class="p">,</span> <span class="n">forecast_subset</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
    <span class="n">forecast_subset</span><span class="o">.</span><span class="n">subset_forecast</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">forecast_subset</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tristan Schuler, Chinthan Prasad.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>